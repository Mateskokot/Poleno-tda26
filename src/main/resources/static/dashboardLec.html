<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard – Lektor</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>

<header class="topbar">
  <div class="topbar__inner">
    <a class="logo-link" href="/indexlec"><img src="/images/logo.png" alt="Think Different Academy"></a><nav class="nav">
      <a href="/indexlec" class="nav__link">Domů</a>
      <a href="/courses" class="nav__link">Kurzy</a>
      <a href="/manageLec" class="nav__link">Správa kurzu</a>
      <a href="#upload" class="nav__link">Materiály</a>
      <a href="/loginLec" class="nav__link nav__link--button" id="logoutBtn">Odhlásit</a>
    </nav>
  </div>
</header>

<main class="container">
  <h1>Dashboard lektora</h1>

  <div class="card" id="upload">
    <h2 style="margin-top:0;">Nahrání materiálu do kurzu</h2>

    <p class="small" id="status" style="margin-top:6px;"></p>

    <form id="uploadForm" class="form" enctype="multipart/form-data">
      <label>
        Kurz
        <select id="courseSelect" required>
          <option value="">Načítám kurzy…</option>
        </select>
      </label>

      <label>
        Název materiálu
        <input type="text" id="title" placeholder="Např. Prezentace – kapitola" required>
      </label>

      <label>
        Soubor
        <input type="file" id="file" required>
      </label>

      <button type="submit">Nahrát materiál</button>
    </form>

    <hr style="margin:18px 0; opacity:.2;">

    <h2 style="margin-top:0;">Vložit odkaz (URL) do kurzu</h2>
    <form id="linkForm" class="form">
      <label>
        Kurz
        <select id="courseSelectLink" required>
          <option value="">Načítám kurzy…</option>
        </select>
      </label>

      <label>
        Název odkazu
        <input type="text" id="linkTitle" placeholder="Např. YouTube – kapitola 1" required>
      </label>

      <label>
        URL
        <input type="url" id="linkUrl" placeholder="https://..." required>
      </label>

      <label>
        Popis (volitelné)
        <input type="text" id="linkDesc" placeholder="Krátký popis">
      </label>

      <button type="submit">Přidat odkaz</button>
      <p class="small" id="linkStatus" style="margin-top:8px;"></p>
    </form>

    <hr style="margin:18px 0; opacity:.2;">

    <h2 style="margin-top:0;">Materiály ve vybraném kurzu</h2>
    <p class="small" style="margin-top:6px; opacity:.85;">Vyber kurz nahoře a materiály se zobrazí zde.</p>
    <div id="materialsList" class="small">—</div>

    <hr style="margin:18px 0; opacity:.2;">

    <h2 style="margin-top:0;">Kvízy – statistiky</h2>
    <p class="small" style="margin-top:6px; opacity:.85;">Vyber kurz a kvíz. Zobrazí se souhrnné statistiky.</p>

    <form id="quizStatsForm" class="form">
      <label>
        Kurz
        <select id="quizCourseSelect" required>
          <option value="">Načítám kurzy…</option>
        </select>
      </label>

      <label>
        Kvíz
        <select id="quizSelect" required>
          <option value="">Nejprve vyber kurz…</option>
        </select>
      </label>
    </form>

    <div id="quizStats" class="small" style="margin-top:10px;">—</div>
    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
      <a id="openQuizManage" href="#" style="display:none;">Otevřít správu kvízu</a>
    </div>

    <hr style="margin:18px 0; opacity:.2;">

    <h3 style="margin:0 0 8px;">Moje kurzy</h3>
    <div id="coursesList" class="small">Načítám…</div>

    <p class="small" style="margin-top:12px; opacity:.8;">
      Debug: <span id="debugInfo">—</span>
    </p>
  </div>
</main>

<script>
// Musí být stejné jako v loginLec (js/LoginLec.js)
const TOKEN_KEY = "lecturerToken";

function getToken() {
  return localStorage.getItem(TOKEN_KEY);
}

function setStatus(text, isError = false) {
  const el = document.getElementById("status");
  el.textContent = text || "";
  el.style.color = isError ? "crimson" : "";
}

function setDebug(text) {
  const el = document.getElementById("debugInfo");
  if (el) el.textContent = text;
}

function requireLogin() {
  const token = getToken();
  if (!token) {
    window.location.href = "/loginLec";
    return false;
  }
  return true;
}

async function loadCourses() {
  if (!requireLogin()) return;

  const token = getToken();
  const select = document.getElementById("courseSelect");
  const selectLink = document.getElementById("courseSelectLink");
  const quizCourseSelect = document.getElementById("quizCourseSelect");
  const list = document.getElementById("coursesList");

  select.innerHTML = `<option value="">Načítám kurzy…</option>`;
  selectLink.innerHTML = `<option value="">Načítám kurzy…</option>`;
  quizCourseSelect.innerHTML = `<option value="">Načítám kurzy…</option>`;
  list.textContent = "Načítám…";
  setStatus("");
  setDebug("token OK");

  // ✅ STEJNĚ jako v courses
  const COURSES_URL = "/api/courses";

  try {
    const res = await fetch(COURSES_URL, {
      method: "GET",
      // pokud api/courses token nepotřebuje, nevadí; pokud potřebuje, takhle ho pošleš
      headers: token ? { "Authorization": "Bearer " + token } : {}
    });

    if (!res.ok) {
      const txt = await res.text().catch(() => "");
      select.innerHTML = `<option value="">Kurzy nelze načíst</option>`;
      selectLink.innerHTML = `<option value="">Kurzy nelze načíst</option>`;
      quizCourseSelect.innerHTML = `<option value="">Kurzy nelze načíst</option>`;
      list.textContent = `Kurzy nelze načíst. HTTP ${res.status}` + (txt ? ` – ${txt}` : "");
      setStatus(`Chyba načítání kurzů (HTTP ${res.status}).`, true);
      setDebug(`GET ${COURSES_URL} -> ${res.status}`);
      return;
    }

    const courses = await res.json();
    if (!Array.isArray(courses) || courses.length === 0) {
      select.innerHTML = `<option value="">Žádné kurzy</option>`;
      selectLink.innerHTML = `<option value="">Žádné kurzy</option>`;
      quizCourseSelect.innerHTML = `<option value="">Žádné kurzy</option>`;
      list.textContent = "Žádné kurzy nejsou k dispozici.";
      setStatus("Kurzy načteny, ale seznam je prázdný.", true);
      setDebug(`GET ${COURSES_URL} -> 200, 0 kurzů`);
      return;
    }

    // ✅ mapování podle toho, co vrací course: title, id, lecturer
    select.innerHTML = `<option value="">Vyber kurz…</option>`;
    selectLink.innerHTML = `<option value="">Vyber kurz…</option>`;
    quizCourseSelect.innerHTML = `<option value="">Vyber kurz…</option>`;
    for (const c of courses) {
      const id = c.id;
      const title = c.title ?? ("Kurz " + id);
      if (id == null) continue;

      const opt = document.createElement("option");
      opt.value = String(id);
      opt.textContent = title;
      select.appendChild(opt);

      const opt2 = document.createElement("option");
      opt2.value = String(id);
      opt2.textContent = title;
      selectLink.appendChild(opt2);

      const opt3 = document.createElement("option");
      opt3.value = String(id);
      opt3.textContent = title;
      quizCourseSelect.appendChild(opt3);
    }

    list.innerHTML = courses.map(c => `• ${c.title ?? ("Kurz " + c.id)}`).join("<br>");

    setStatus("Kurzy byly načteny.");
    setDebug(`GET ${COURSES_URL} -> 200, ${courses.length} kurzů`);

  } catch (e) {
    select.innerHTML = `<option value="">Chyba připojení</option>`;
    selectLink.innerHTML = `<option value="">Chyba připojení</option>`;
    quizCourseSelect.innerHTML = `<option value="">Chyba připojení</option>`;
    list.textContent = "Chyba připojení k serveru.";
    setStatus("Chyba připojení k serveru.", true);
    setDebug("fetch failed");
  }
}

// -------------------- QUIZ STATS (Fáze 3) --------------------
async function loadQuizzes(courseId) {
  const url = `/api/courses/${encodeURIComponent(courseId)}/quizzes`;
  const res = await fetch(url);
  if (!res.ok) return [];
  const data = await res.json().catch(() => []);
  return Array.isArray(data) ? data : [];
}

async function loadQuizResults(courseId, quizId) {
  const token = getToken();
  const url = `/api/courses/${encodeURIComponent(courseId)}/quizzes/${encodeURIComponent(quizId)}/results`;
  const res = await fetch(url, {
    headers: { "Authorization": "Bearer " + token }
  });
  if (res.status === 401) throw new Error("Unauthorized");
  if (!res.ok) {
    const txt = await res.text().catch(() => "");
    throw new Error(`HTTP ${res.status}` + (txt ? ` – ${txt}` : ""));
  }
  const data = await res.json().catch(() => []);
  return Array.isArray(data) ? data : [];
}

function computeStats(results) {
  const list = Array.isArray(results) ? results : [];
  const attempts = list.length;
  if (attempts === 0) {
    return { attempts: 0, avg: 0, best: 0 };
  }
  const percents = list.map(r => {
    const t = Number(r.totalQuestions || 0);
    const c = Number(r.correctQuestions || 0);
    return t > 0 ? (c * 100.0 / t) : 0;
  });
  const avg = percents.reduce((a, b) => a + b, 0) / attempts;
  const best = Math.max(...percents);
  return { attempts, avg, best };
}

function setQuizStatsText(text) {
  const el = document.getElementById("quizStats");
  if (el) el.textContent = text;
}

function setQuizManageLink(courseId, quizId, visible) {
  const link = document.getElementById("openQuizManage");
  if (!link) return;
  link.href = `/quizManage?courseId=${encodeURIComponent(courseId)}&quizId=${encodeURIComponent(quizId)}`;
  link.style.display = visible ? "inline" : "none";
}

function esc(s) {
  return String(s ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function humanSize(bytes) {
  const b = Number(bytes || 0);
  if (!Number.isFinite(b)) return "";
  if (b < 1024) return b + " B";
  const kb = b / 1024;
  if (kb < 1024) return kb.toFixed(1) + " KB";
  const mb = kb / 1024;
  return mb.toFixed(1) + " MB";
}

async function loadMaterials(courseId) {
  const url = `/api/courses/${encodeURIComponent(courseId)}/materials`;
  const res = await fetch(url);
  if (!res.ok) return [];
  const data = await res.json().catch(() => []);
  return Array.isArray(data) ? data : [];
}

function renderMaterials(courseId, items) {
  const root = document.getElementById("materialsList");
  if (!courseId) {
    root.textContent = "—";
    return;
  }
  if (!items || items.length === 0) {
    root.innerHTML = "<em>Zatím žádné materiály.</em>";
    return;
  }

  root.innerHTML = items.map(m => {
    const type = String(m.type ?? "FILE").toUpperCase();
    const title = esc(m.title ?? "Materiál");
    const desc = esc(m.description ?? "");
    if (type === "LINK") {
      const url = esc(m.url ?? "");
      return `
        <div class="card" style="margin-top:12px;">
          <strong>${title}</strong>
          ${desc ? `<div class="small" style="opacity:.85; margin-top:6px;">${desc}</div>` : ""}
          <div style="margin-top:10px;"><a href="${url}" target="_blank" rel="noopener noreferrer">Otevřít odkaz</a></div>
          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <button type="button" data-action="edit" data-id="${esc(m.id)}" class="nav__link nav__link--button" style="padding:8px 12px;">Upravit</button>
            <button type="button" data-action="delete" data-id="${esc(m.id)}" class="nav__link" style="padding:8px 12px; border:1px solid rgba(255,255,255,.2);">Smazat</button>
          </div>
        </div>
      `;
    }

    const file = esc(m.originalFilename ?? "");
    const size = m.sizeBytes != null ? humanSize(m.sizeBytes) : "";
    const href = `/api/courses/${encodeURIComponent(courseId)}/materials/${encodeURIComponent(m.id)}/download`;
    return `
      <div class="card" style="margin-top:12px;">
        <strong>${title}</strong>
        ${desc ? `<div class="small" style="opacity:.85; margin-top:6px;">${desc}</div>` : ""}
        ${file ? `<div class="small" style="margin-top:8px;">Soubor: ${file}${size ? ` (${size})` : ""}</div>` : ""}
        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
          <a href="${href}">Stáhnout</a>
          <button type="button" data-action="edit" data-id="${esc(m.id)}" class="nav__link nav__link--button" style="padding:8px 12px;">Upravit</button>
          <button type="button" data-action="delete" data-id="${esc(m.id)}" class="nav__link" style="padding:8px 12px; border:1px solid rgba(255,255,255,.2);">Smazat</button>
        </div>
      </div>
    `;
  }).join("");
}

let currentMaterials = [];

async function refreshMaterialsFromSelected() {
  const courseId = document.getElementById("courseSelect").value;
  const items = courseId ? await loadMaterials(courseId) : [];
  currentMaterials = Array.isArray(items) ? items : [];
  renderMaterials(courseId, items);
}

async function updateMaterial(courseId, materialId, payload) {
  const token = getToken();
  const url = `/api/courses/${encodeURIComponent(courseId)}/materials/${encodeURIComponent(materialId)}`;
  const res = await fetch(url, {
    method: "PUT",
    headers: {
      "Authorization": "Bearer " + token,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(payload)
  });
  if (!res.ok) {
    const txt = await res.text().catch(() => "");
    throw new Error(`Uprava se nepovedla (HTTP ${res.status}). ` + (txt || ""));
  }
  return await res.json().catch(() => null);
}

async function deleteMaterial(courseId, materialId) {
  const token = getToken();
  const url = `/api/courses/${encodeURIComponent(courseId)}/materials/${encodeURIComponent(materialId)}`;
  const res = await fetch(url, {
    method: "DELETE",
    headers: { "Authorization": "Bearer " + token }
  });
  if (!res.ok) {
    const txt = await res.text().catch(() => "");
    throw new Error(`Smazani se nepovedlo (HTTP ${res.status}). ` + (txt || ""));
  }
  return await res.json().catch(() => null);
}

// edit/delete actions for listed materials
document.getElementById("materialsList").addEventListener("click", async (e) => {
  const btn = e.target.closest("button[data-action]");
  if (!btn) return;
  if (!requireLogin()) return;

  const action = btn.getAttribute("data-action");
  const id = btn.getAttribute("data-id");
  const courseId = document.getElementById("courseSelect").value;
  if (!courseId || !id) return;

  const m = (currentMaterials || []).find(x => String(x.id) === String(id));
  if (!m) {
    setStatus("Materiál už neexistuje (obnov stránku).", true);
    return;
  }

  try {
    if (action === "delete") {
      if (!confirm(`Opravdu smazat: ${m.title || "materiál"}?`)) return;
      await deleteMaterial(courseId, id);
      setStatus("Smazáno.");
      await refreshMaterialsFromSelected();
      return;
    }

    if (action === "edit") {
      const type = String(m.type || "FILE").toUpperCase();
      const newTitle = prompt("Nový název:", m.title || "")?.trim();
      if (!newTitle) return;

      let newDesc = prompt("Nový popis (může být prázdný):", m.description || "");
      newDesc = (newDesc == null) ? (m.description || "") : String(newDesc);

      if (type === "LINK") {
        let newUrl = prompt("Nová URL:", m.url || "")?.trim();
        if (!newUrl) return;
        await updateMaterial(courseId, id, { title: newTitle, description: newDesc, url: newUrl });
      } else {
        await updateMaterial(courseId, id, { title: newTitle, description: newDesc });
      }

      setStatus("Upraveno.");
      await refreshMaterialsFromSelected();
      return;
    }
  } catch (err) {
    setStatus(err?.message || "Chyba.", true);
  }
});

document.getElementById("uploadForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!requireLogin()) return;

  const token = getToken();
  const courseId = document.getElementById("courseSelect").value;
  const title = document.getElementById("title").value.trim();
  const fileInput = document.getElementById("file");

  if (!courseId) return setStatus("Vyber kurz.", true);
  if (!title) return setStatus("Vyplň název materiálu.", true);
  if (!fileInput.files || fileInput.files.length === 0) return setStatus("Vyber soubor.", true);

  setStatus("Nahrávám…");

  // Upload endpoint, který materiál skutečně uloží a bude vidět i studentům
  const UPLOAD_URL = `/api/courses/${encodeURIComponent(courseId)}/materials`;

  const fd = new FormData();
  fd.append("title", title);
  fd.append("file", fileInput.files[0]);

  try {
    const res = await fetch(UPLOAD_URL, {
      method: "POST",
      headers: { "Authorization": "Bearer " + token },
      body: fd
    });

    if (!res.ok) {
      const txt = await res.text().catch(() => "");
      setStatus(`Nahrání se nepovedlo (HTTP ${res.status}). ` + (txt || ""), true);
      setDebug(`POST ${UPLOAD_URL} -> ${res.status}`);
      return;
    }

    setStatus("Hotovo. Materiál byl nahrán.");
    setDebug(`POST ${UPLOAD_URL} -> 200/201`);
    e.target.reset();

    // po nahrání rovnou obnov seznam
    await refreshMaterialsFromSelected();

  } catch (err) {
    // Sem se to dostane typicky jen když fetch úplně spadne (např. stránka otevřená jako file://)
    setStatus("Chyba připojení k serveru (fetch selhal). Otevři stránku přes http://localhost:8080.", true);
    setDebug("upload fetch failed: " + (err?.message ?? ""));
  }
});

// při změně kurzu okamžitě zobraz materiály
document.getElementById("courseSelect").addEventListener("change", () => {
  refreshMaterialsFromSelected();
});

// -------------------- QUIZ STATS UI --------------------
const quizCourseSelectEl = document.getElementById("quizCourseSelect");
const quizSelectEl = document.getElementById("quizSelect");

async function refreshQuizList() {
  if (!requireLogin()) return;
  const courseId = quizCourseSelectEl.value;
  setQuizManageLink(courseId || "", "", false);
  setQuizStatsText("—");

  if (!courseId) {
    quizSelectEl.innerHTML = `<option value="">Nejprve vyber kurz…</option>`;
    return;
  }

  quizSelectEl.innerHTML = `<option value="">Načítám kvízy…</option>`;
  try {
    const quizzes = await loadQuizzes(courseId);
    if (!Array.isArray(quizzes) || quizzes.length === 0) {
      quizSelectEl.innerHTML = `<option value="">Žádné kvízy</option>`;
      setQuizStatsText("Zatím žádné kvízy.");
      return;
    }

    quizSelectEl.innerHTML = `<option value="">Vyber kvíz…</option>`;
    quizzes.forEach(q => {
      const opt = document.createElement("option");
      opt.value = String(q.id);
      opt.textContent = q.title || ("Kvíz " + q.id);
      quizSelectEl.appendChild(opt);
    });
  } catch (err) {
    quizSelectEl.innerHTML = `<option value="">Chyba načítání kvízů</option>`;
    setQuizStatsText(err?.message || "Chyba.");
  }
}

async function refreshQuizStats() {
  if (!requireLogin()) return;
  const courseId = quizCourseSelectEl.value;
  const quizId = quizSelectEl.value;
  setQuizManageLink(courseId || "", quizId || "", false);

  if (!courseId || !quizId) {
    setQuizStatsText("—");
    return;
  }

  setQuizStatsText("Načítám statistiky…");
  try {
    const results = await loadQuizResults(courseId, quizId);
    const s = computeStats(results);
    setQuizStatsText(`Vyplněno: ${s.attempts}× • Průměr: ${s.avg.toFixed(1)}% • Nejlepší: ${s.best.toFixed(1)}%`);
    setQuizManageLink(courseId, quizId, true);
  } catch (err) {
    if (String(err?.message || "") === "Unauthorized") {
      location.href = "/loginLec";
      return;
    }
    setQuizStatsText(err?.message || "Chyba.");
  }
}

quizCourseSelectEl.addEventListener("change", async () => {
  await refreshQuizList();
});

quizSelectEl.addEventListener("change", async () => {
  await refreshQuizStats();
});

// vložení odkazu
document.getElementById("linkForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!requireLogin()) return;

    const token = getToken();
    const courseId = document.getElementById("courseSelectLink").value;
    const title = document.getElementById("linkTitle").value.trim();
    const url = document.getElementById("linkUrl").value.trim();
    const description = document.getElementById("linkDesc").value.trim();
    const msg = document.getElementById("linkStatus");

    msg.textContent = "Ukládám…";
    msg.style.color = "";

    if (!courseId) { msg.textContent = "Vyber kurz."; msg.style.color = "crimson"; return; }
    if (!title) { msg.textContent = "Vyplň název."; msg.style.color = "crimson"; return; }
    if (!url) { msg.textContent = "Vyplň URL."; msg.style.color = "crimson"; return; }

    const endpoint = `/api/courses/${encodeURIComponent(courseId)}/materials/link`;

    try {
      const res = await fetch(endpoint, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ title, description, url })
      });

      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        msg.textContent = `Odkaz se nepodařilo uložit (HTTP ${res.status}). ` + (txt || "");
        msg.style.color = "crimson";
        return;
      }

      msg.textContent = "Hotovo. Odkaz byl přidán.";
      e.target.reset();

      // pokud je stejný kurz vybraný i nahoře, obnov
      await refreshMaterialsFromSelected();

    } catch (err) {
      msg.textContent = "Chyba připojení k serveru.";
      msg.style.color = "crimson";
    }
  });

document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.removeItem(TOKEN_KEY);
  location.href = "/loginLec";
});

(async () => {
  await loadCourses();
  await refreshQuizList();
})();
</script>



<footer class="footer">
  <div class="container">
    <small>© Think Different Academy</small>
  </div>
</footer>

</body>
</html>
