<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Správa kvízu</title>
  <link rel="stylesheet" href="/style.css">
</head>

<body>

<header class="topbar">
  <div class="topbar__inner">
    <a class="logo-link" href="/indexlec"><img src="/images/logo.png" alt="Think Different Academy"></a><nav class="nav">
      <a class="nav__link" id="backToCourse" href="#">Zpět na správu kurzu</a>
      <a class="nav__link" href="/dashboardLec">Dashboard</a>
      <a class="nav__link nav__link--button" href="#" id="logoutBtn">Odhlásit</a>
    </nav>
  </div>
</header>

<main class="container">
  <h1 id="pageTitle">Správa kvízu</h1>
  <p id="err" class="small" style="color:#ff6b6b;"></p>

  <section class="card">
    <h2 style="margin-top:0;">Nastavení kvízu</h2>
    <form id="titleForm" class="form">
      <label>
        Název kvízu
        <input type="text" name="title" required>
      </label>
      <button type="submit">Uložit název</button>
      <p id="titleMsg" class="small"></p>
    </form>
  </section>

  <section class="card" style="margin-top:16px;">
    <h2 style="margin-top:0;">Otázky</h2>
    <p class="small" style="opacity:.85;">Přidávej a upravuj otázky. SINGLE = jedna správná, MULTI = více správných.</p>

    <form id="questionForm" class="form" style="margin-top:12px;">
      <input type="hidden" name="questionId" value="">

      <label>
        Typ otázky
        <select name="type" required>
          <option value="SINGLE">SINGLE (jedna správná)</option>
          <option value="MULTI">MULTI (více správných)</option>
        </select>
      </label>

      <label>
        Text otázky
        <input type="text" name="text" required placeholder="Např. Co je JVM?">
      </label>

      <div>
        <div class="small" style="margin:6px 0; opacity:.85;">Možnosti</div>
        <div id="options"></div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
          <button type="button" id="addOptionBtn">Přidat možnost</button>
          <button type="button" id="resetQuestionBtn">Zrušit úpravu</button>
        </div>
      </div>

      <button type="submit" id="saveQuestionBtn" style="margin-top:10px;">Uložit otázku</button>
      <p id="questionMsg" class="small"></p>
    </form>

    <div id="questionsList" style="margin-top:14px;"></div>
  </section>

  <section class="card" style="margin-top:16px;" id="resultsSection">
    <h2 style="margin-top:0;">Výsledky (anonymně)</h2>
    <div id="resultsSummary" class="small">—</div>
    <div id="resultsList" class="small" style="margin-top:10px;"></div>
  </section>
</main>

<script>
const TOKEN_KEY = "lecturerToken";

function getToken() {
  return localStorage.getItem(TOKEN_KEY);
}

function requireLogin() {
  if (!getToken()) {
    location.href = "/loginLec";
    return false;
  }
  return true;
}

function qp(name) {
  return new URLSearchParams(location.search).get(name);
}

function esc(s) {
  return String(s ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function setErr(msg) {
  document.getElementById("err").textContent = msg || "";
}

function uuid() {
  // browser safe UUID
  if (typeof crypto !== "undefined" && crypto.randomUUID) return crypto.randomUUID();
  return "id-" + Math.random().toString(16).slice(2) + "-" + Date.now();
}

async function fetchJson(url, opts) {
  const res = await fetch(url, opts || {});
  const ct = (res.headers.get("content-type") || "").toLowerCase();
  if (!res.ok) {
    const body = ct.includes("application/json") ? await res.json().catch(() => null) : await res.text().catch(() => "");
    const msg = (body && body.error) ? body.error : (typeof body === "string" ? body : "");
    if (res.status === 401) throw new Error("Unauthorized");
    throw new Error(`HTTP ${res.status}${msg ? " – " + msg : ""}`);
  }
  if (!ct.includes("application/json")) {
    const text = await res.text().catch(() => "");
    throw new Error("Server nevrátil JSON. " + text.slice(0, 120));
  }
  return await res.json();
}

function optionRow(optionId, text, type, checked) {
  const row = document.createElement("div");
  row.className = "card";
  row.style.marginTop = "10px";
  row.dataset.oid = optionId;

  row.innerHTML = `
    <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
      <input type="${type === "MULTI" ? "checkbox" : "radio"}" name="correct" ${checked ? "checked" : ""}>
      <input type="text" class="optText" placeholder="Text možnosti" value="${esc(text)}" style="flex:1; min-width:220px;">
      <button type="button" class="removeOptBtn">Smazat</button>
    </div>
  `;
  return row;
}

function readQuestionForm() {
  const form = document.getElementById("questionForm");
  const fd = new FormData(form);
  const qId = (fd.get("questionId") || "").toString().trim();
  const type = (fd.get("type") || "SINGLE").toString().toUpperCase();
  const text = (fd.get("text") || "").toString().trim();

  const optionsRoot = document.getElementById("options");
  const optionRows = Array.from(optionsRoot.querySelectorAll("div[data-oid]"));
  const options = optionRows.map(r => {
    const oid = r.dataset.oid;
    const txt = (r.querySelector(".optText")?.value || "").toString().trim();
    return { id: oid, text: txt };
  }).filter(o => o.text);

  // correct selections
  let correct = [];
  optionRows.forEach(r => {
    const oid = r.dataset.oid;
    const input = r.querySelector("input[name='correct']");
    if (input && input.checked) correct.push(oid);
  });

  // UX: pokud lektor zapomene označit správnou odpověď, u SINGLE automaticky nastavíme první možnost.
  // Backend stejně vyžaduje 1 správnou odpověď pro SINGLE.
  if (type === "SINGLE" && correct.length === 0 && options.length > 0) {
    correct = [options[0].id];
  }

  return {
    id: qId || null,
    type,
    text,
    options,
    correctOptionIds: correct
  };
}

function resetQuestionForm() {
  const form = document.getElementById("questionForm");
  form.reset();
  form.querySelector("input[name='questionId']").value = "";
  document.getElementById("options").innerHTML = "";
  // create 2 empty options
  // u SINGLE rovnou nastavíme první možnost jako správnou, aby šlo otázku uložit bez zbytečných chyb
  addOption(null, "", true);
  addOption();
  document.getElementById("questionMsg").textContent = "";
  document.getElementById("saveQuestionBtn").textContent = "Uložit otázku";
}

function setOptionsInputType(type) {
  const optionsRoot = document.getElementById("options");
  optionsRoot.querySelectorAll("div[data-oid]").forEach(r => {
    const old = r.querySelector("input[name='correct']");
    const checked = old?.checked;
    if (!old) return;
    const replacement = document.createElement("input");
    replacement.type = (type === "MULTI") ? "checkbox" : "radio";
    replacement.name = "correct";
    replacement.checked = !!checked;
    old.replaceWith(replacement);
  });

  // u SINGLE hlídáme, aby bylo označeno alespoň něco
  if (String(type).toUpperCase() === "SINGLE") {
    const first = optionsRoot.querySelector("div[data-oid] input[name='correct']");
    const anyChecked = !!optionsRoot.querySelector("input[name='correct']:checked");
    if (first && !anyChecked) first.checked = true;
  }
}

function addOption(id, text, checked) {
  const form = document.getElementById("questionForm");
  const type = (new FormData(form).get("type") || "SINGLE").toString().toUpperCase();
  const optionId = id || uuid();
  const row = optionRow(optionId, text || "", type, !!checked);
  document.getElementById("options").appendChild(row);
}

function renderQuestions(quiz) {
  const root = document.getElementById("questionsList");
  const qs = Array.isArray(quiz?.questions) ? quiz.questions : [];

  if (qs.length === 0) {
    root.innerHTML = "<p class='small'><em>Zatím žádné otázky.</em></p>";
    return;
  }

  root.innerHTML = "";
  qs.forEach((q, idx) => {
    const card = document.createElement("div");
    card.className = "card";
    card.style.marginTop = "12px";
    card.dataset.qid = q.id;

    const type = String(q.type || "SINGLE").toUpperCase();
    const correct = new Set((q.correctOptionIds || []).map(String));
    const opts = (q.options || []).map(o => {
      const mark = correct.has(String(o.id)) ? "✓" : "";
      return `<div class='small' style='margin-top:6px;'>${mark ? "<strong>" + mark + "</strong> " : ""}${esc(o.text)}</div>`;
    }).join("");

    card.innerHTML = `
      <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start; flex-wrap:wrap;">
        <div>
          <strong>${idx + 1}. ${esc(q.text || "")}</strong>
          <div class="small" style="margin-top:6px; opacity:.85;">Typ: ${esc(type)}</div>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button type="button" data-action="edit" data-id="${esc(q.id)}">Upravit</button>
          <button type="button" data-action="delete" data-id="${esc(q.id)}">Smazat</button>
        </div>
      </div>
      <div style="margin-top:10px;">${opts}</div>
    `;

    root.appendChild(card);
  });
}

function renderResults(results) {
  const list = Array.isArray(results) ? results : [];
  const summaryEl = document.getElementById("resultsSummary");
  const root = document.getElementById("resultsList");

  const attempts = list.length;
  let avg = 0;
  let best = 0;
  if (attempts > 0) {
    const percents = list.map(r => {
      const t = Number(r.totalQuestions || 0);
      const c = Number(r.correctQuestions || 0);
      return t > 0 ? (c * 100.0 / t) : 0;
    });
    avg = percents.reduce((a, b) => a + b, 0) / attempts;
    best = Math.max(...percents);
  }
  summaryEl.textContent = `Vyplněno: ${attempts}× • Průměr: ${avg.toFixed(1)}% • Nejlepší: ${best.toFixed(1)}%`;

  if (attempts === 0) {
    root.innerHTML = "<em>Zatím žádné výsledky.</em>";
    return;
  }

  root.innerHTML = list.map(r => {
    const when = r.submittedAt ? new Date(r.submittedAt).toLocaleString("cs-CZ") : "";
    const t = Number(r.totalQuestions || 0);
    const c = Number(r.correctQuestions || 0);
    const p = t > 0 ? (c * 100.0 / t) : 0;
    return `• ${esc(when)} – ${c}/${t} (${p.toFixed(1)}%)`;
  }).join("<br>");
}

async function loadFullQuiz(courseId, quizId) {
  return await fetchJson(`/api/courses/${encodeURIComponent(courseId)}/quizzes/${encodeURIComponent(quizId)}/full`, {
    headers: { "Authorization": "Bearer " + getToken() }
  });
}

async function saveTitle(courseId, quizId, title) {
  return await fetchJson(`/api/courses/${encodeURIComponent(courseId)}/quizzes/${encodeURIComponent(quizId)}`, {
    method: "PUT",
    headers: {
      "Authorization": "Bearer " + getToken(),
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ title })
  });
}

async function upsertQuestion(courseId, quizId, q) {
  return await fetchJson(`/api/courses/${encodeURIComponent(courseId)}/quizzes/${encodeURIComponent(quizId)}/questions`, {
    method: "POST",
    headers: {
      "Authorization": "Bearer " + getToken(),
      "Content-Type": "application/json"
    },
    body: JSON.stringify(q)
  });
}

async function deleteQuestion(courseId, quizId, questionId) {
  return await fetchJson(`/api/courses/${encodeURIComponent(courseId)}/quizzes/${encodeURIComponent(quizId)}/questions/${encodeURIComponent(questionId)}`, {
    method: "DELETE",
    headers: { "Authorization": "Bearer " + getToken() }
  });
}

async function loadResults(courseId, quizId) {
  return await fetchJson(`/api/courses/${encodeURIComponent(courseId)}/quizzes/${encodeURIComponent(quizId)}/results`, {
    headers: { "Authorization": "Bearer " + getToken() }
  });
}

document.getElementById("logoutBtn").addEventListener("click", (e) => {
  e.preventDefault();
  localStorage.removeItem(TOKEN_KEY);
  location.href = "/loginLec";
});

document.getElementById("addOptionBtn").addEventListener("click", () => addOption());
document.getElementById("resetQuestionBtn").addEventListener("click", () => resetQuestionForm());

document.getElementById("options").addEventListener("click", (e) => {
  const btn = e.target.closest(".removeOptBtn");
  if (!btn) return;
  const row = btn.closest("div[data-oid]");
  if (row) row.remove();
});

document.getElementById("questionForm").addEventListener("change", (e) => {
  if (e.target && e.target.name === "type") {
    setOptionsInputType(String(e.target.value || "SINGLE").toUpperCase());
  }
});

document.getElementById("titleForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!requireLogin()) return;

  const courseId = qp("courseId");
  const quizId = qp("quizId");
  const msg = document.getElementById("titleMsg");
  msg.textContent = "Ukládám…";

  const title = (new FormData(e.target).get("title") || "").toString().trim();
  try {
    const updated = await saveTitle(courseId, quizId, title);
    msg.textContent = "Uloženo.";
    document.getElementById("pageTitle").textContent = `Správa kvízu: ${updated.title || ""}`;
  } catch (ex) {
    msg.textContent = ex?.message || "Chyba.";
    if (String(ex?.message || "") === "Unauthorized") location.href = "/loginLec";
  }
});

document.getElementById("questionForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!requireLogin()) return;

  const courseId = qp("courseId");
  const quizId = qp("quizId");
  const msg = document.getElementById("questionMsg");
  msg.textContent = "Ukládám…";
  setErr("");

  try {
    const q = readQuestionForm();
    if (!q.text) throw new Error("Text otázky nesmí být prázdný.");
    if (!Array.isArray(q.options) || q.options.length < 2) throw new Error("Zadej alespoň 2 možnosti.");
    if (q.type === "SINGLE" && q.correctOptionIds.length !== 1) throw new Error("SINGLE musí mít právě 1 správnou možnost.");
    if (q.type === "MULTI" && q.correctOptionIds.length < 1) throw new Error("MULTI musí mít alespoň 1 správnou možnost.");

    // backend accepts null id for new question
    const payload = {
      id: q.id,
      type: q.type,
      text: q.text,
      options: q.options,
      correctOptionIds: q.correctOptionIds
    };
    const updatedQuiz = await upsertQuestion(courseId, quizId, payload);
    msg.textContent = "Uloženo.";
    renderQuestions(updatedQuiz);
    resetQuestionForm();
  } catch (ex) {
    msg.textContent = "";
    if (String(ex?.message || "") === "Unauthorized") {
      location.href = "/loginLec";
      return;
    }
    setErr(ex?.message || "Chyba.");
  }
});

document.getElementById("questionsList").addEventListener("click", async (e) => {
  const btn = e.target.closest("button[data-action]");
  if (!btn) return;
  if (!requireLogin()) return;

  const courseId = qp("courseId");
  const quizId = qp("quizId");
  const qid = btn.getAttribute("data-id");
  const action = btn.getAttribute("data-action");

  try {
    const quiz = await loadFullQuiz(courseId, quizId);
    const qs = Array.isArray(quiz?.questions) ? quiz.questions : [];
    const q = qs.find(x => String(x.id) === String(qid));
    if (!q) throw new Error("Otázka už neexistuje.");

    if (action === "delete") {
      if (!confirm("Opravdu smazat tuto otázku?")) return;
      const updated = await deleteQuestion(courseId, quizId, qid);
      renderQuestions(updated);
      return;
    }

    if (action === "edit") {
      // fill form
      const form = document.getElementById("questionForm");
      form.querySelector("input[name='questionId']").value = q.id;
      form.querySelector("select[name='type']").value = String(q.type || "SINGLE").toUpperCase();
      form.querySelector("input[name='text']").value = q.text || "";
      document.getElementById("saveQuestionBtn").textContent = "Uložit úpravu";

      const correct = new Set((q.correctOptionIds || []).map(String));
      const optionsRoot = document.getElementById("options");
      optionsRoot.innerHTML = "";
      (q.options || []).forEach(o => addOption(String(o.id), String(o.text || ""), correct.has(String(o.id))));
      setOptionsInputType(String(q.type || "SINGLE").toUpperCase());

      window.scrollTo({ top: document.getElementById("questionForm").offsetTop - 80, behavior: "smooth" });
      return;
    }
  } catch (ex) {
    if (String(ex?.message || "") === "Unauthorized") {
      location.href = "/loginLec";
      return;
    }
    setErr(ex?.message || "Chyba.");
  }
});

(async () => {
  if (!requireLogin()) return;

  const courseId = qp("courseId");
  const quizId = qp("quizId");
  if (!courseId || !quizId) {
    setErr("Chybí parametr courseId nebo quizId.");
    return;
  }

  document.getElementById("backToCourse").href = `/courseLec?id=${encodeURIComponent(courseId)}`;

  try {
    resetQuestionForm();
    const quiz = await loadFullQuiz(courseId, quizId);
    document.getElementById("pageTitle").textContent = `Správa kvízu: ${quiz.title || ""}`;
    document.querySelector("#titleForm input[name='title']").value = quiz.title || "";
    renderQuestions(quiz);

    const results = await loadResults(courseId, quizId);
    renderResults(results);

    if (location.hash === "#results") {
      document.getElementById("resultsSection").scrollIntoView({ behavior: "smooth" });
    }
  } catch (ex) {
    if (String(ex?.message || "") === "Unauthorized") {
      location.href = "/loginLec";
      return;
    }
    setErr(ex?.message || "Chyba při načítání.");
  }
})();
</script>



<footer class="footer">
  <div class="container">
    <small>© Think Different Academy</small>
  </div>
</footer>

</body>
</html>
