<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Kvíz</title>
  <link rel="stylesheet" href="/style.css">
</head>

<body>

<header class="topbar">
  <div class="topbar__inner">
    <a class="logo-link" href="/index"><img src="/images/logo.png" alt="Think Different Academy"></a><nav class="nav">
      <a class="nav__link" id="backLink" href="#">Zpět na kurz</a>
      <a class="nav__link" href="/index">Domů</a>
    </nav>
  </div>
</header>

<main class="container">
  <h1 id="title">Kvíz</h1>
  <p id="err" class="small" style="color:#ff6b6b;"></p>

  <section class="card" id="quizCard">
    <p class="small">Načítám…</p>
  </section>

  <section class="card" style="margin-top:16px;" id="resultCard" hidden>
    <h2 style="margin-top:0;">Výsledek</h2>
    <p id="resultText"></p>
  </section>
</main>

<script>
function qp(name) {
  return new URLSearchParams(location.search).get(name);
}

function esc(s) {
  return String(s ?? "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}

function setErr(msg) {
  document.getElementById("err").textContent = msg || "";
}

async function fetchJson(url, opts) {
  const res = await fetch(url, opts || {});
  const ct = (res.headers.get("content-type") || "").toLowerCase();

  if (!res.ok) {
    const body = ct.includes("application/json") ? await res.json().catch(() => null) : await res.text().catch(() => "");
    const msg = (body && body.error) ? body.error : (typeof body === "string" ? body : "");
    throw new Error(`HTTP ${res.status}${msg ? " – " + msg : ""}`);
  }

  if (!ct.includes("application/json")) {
    const text = await res.text().catch(() => "");
    throw new Error("Server nevrátil JSON. " + text.slice(0, 100));
  }
  return await res.json();
}

function buildForm(quiz) {
  const root = document.getElementById("quizCard");

  if (!quiz || !Array.isArray(quiz.questions) || quiz.questions.length === 0) {
    root.innerHTML = `
      <p class="small"><em>Tento kvíz zatím nemá žádné otázky.</em></p>
    `;
    return;
  }

  const form = document.createElement("form");
  form.className = "form";
  form.id = "quizForm";

  quiz.questions.forEach((q, idx) => {
    const card = document.createElement("div");
    card.className = "card";
    card.style.marginTop = "12px";
    card.dataset.qid = q.id;

    const type = String(q.type || "SINGLE").toUpperCase();
    const isMulti = type === "MULTI";

    card.innerHTML = `
      <strong>${idx + 1}. ${esc(q.text || "")}</strong>
      <div class="small" style="margin-top:8px; opacity:.85;">${isMulti ? "Více možností" : "Jedna možnost"}</div>
      <div style="margin-top:10px;" class="opts"></div>
    `;

    const opts = card.querySelector(".opts");
    (q.options || []).forEach(o => {
      const row = document.createElement("label");
      row.style.display = "block";
      row.style.margin = "8px 0";

      const input = document.createElement("input");
      input.type = isMulti ? "checkbox" : "radio";
      input.name = q.id;
      input.value = o.id;
      input.style.marginRight = "8px";

      const span = document.createElement("span");
      span.textContent = o.text || "";
      span.dataset.oid = o.id;

      row.appendChild(input);
      row.appendChild(span);
      opts.appendChild(row);
    });

    form.appendChild(card);
  });

  const btn = document.createElement("button");
  btn.type = "submit";
  btn.textContent = "Odeslat";
  btn.style.marginTop = "12px";
  form.appendChild(btn);

  const status = document.createElement("p");
  status.id = "submitStatus";
  status.className = "small";
  status.style.marginTop = "8px";
  form.appendChild(status);

  root.innerHTML = "";
  root.appendChild(form);
}

function collectAnswers(quiz) {
  const answers = {};
  for (const q of (quiz.questions || [])) {
    const type = String(q.type || "SINGLE").toUpperCase();
    const nodes = document.querySelectorAll(`input[name='${CSS.escape(q.id)}']`);
    const sel = [];
    nodes.forEach(n => {
      if (n.checked) sel.push(n.value);
    });
    // u SINGLE to bude max 1; u MULTI více
    answers[q.id] = sel;
  }
  return answers;
}

function showResult(resp) {
  const card = document.getElementById("resultCard");
  card.hidden = false;
  document.getElementById("resultText").textContent =
    `Správně ${resp.correctQuestions} z ${resp.totalQuestions} (${resp.scorePercent}%).`;
}

function markAnswers(resp) {
  const details = resp.details || [];
  const byQ = new Map(details.map(d => [d.questionId, d]));

  document.querySelectorAll("[data-qid]").forEach(card => {
    const qid = card.dataset.qid;
    const d = byQ.get(qid);
    if (!d) return;

    const correctSet = new Set(d.correctOptionIds || []);
    const selectedSet = new Set(d.selectedOptionIds || []);

    // highlight each option text
    card.querySelectorAll("span[data-oid]").forEach(span => {
      const oid = span.dataset.oid;
      const isCorrect = correctSet.has(oid);
      const isSelected = selectedSet.has(oid);
      // background + border
      if (isCorrect) {
        span.style.background = "rgba(46, 204, 113, 0.18)";
        span.style.border = "1px solid rgba(46, 204, 113, 0.45)";
        span.style.padding = "2px 6px";
        span.style.borderRadius = "8px";
      }
      if (isSelected && !isCorrect) {
        span.style.background = "rgba(231, 76, 60, 0.18)";
        span.style.border = "1px solid rgba(231, 76, 60, 0.45)";
        span.style.padding = "2px 6px";
        span.style.borderRadius = "8px";
      }
    });

    // disable inputs after submit
    card.querySelectorAll("input").forEach(i => i.disabled = true);

    // per-question badge
    const badge = document.createElement("div");
    badge.className = "small";
    badge.style.marginTop = "10px";
    badge.style.fontWeight = "600";
    badge.textContent = d.correct ? "Správně" : "Špatně";
    badge.style.color = d.correct ? "#2ecc71" : "#ff6b6b";
    card.appendChild(badge);
  });
}

(async () => {
  const courseId = qp("courseId");
  const quizId = qp("quizId");

  if (!courseId || !quizId) {
    setErr("Chybí parametr courseId nebo quizId.");
    document.getElementById("quizCard").innerHTML = "";
    return;
  }

  document.getElementById("backLink").href = `/courseDetail?id=${encodeURIComponent(courseId)}`;

  try {
    const quiz = await fetchJson(`/api/courses/${encodeURIComponent(courseId)}/quizzes/${encodeURIComponent(quizId)}`);
    document.getElementById("title").textContent = quiz.title ? `Kvíz: ${quiz.title}` : "Kvíz";
    buildForm(quiz);

    const form = document.getElementById("quizForm");
    if (!form) return;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      setErr("");
      const status = document.getElementById("submitStatus");
      if (status) status.textContent = "Odesílám…";

      try {
        const answers = collectAnswers(quiz);
        const resp = await fetchJson(`/api/courses/${encodeURIComponent(courseId)}/quizzes/${encodeURIComponent(quizId)}/submit`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ answers })
        });

        if (status) status.textContent = "Hotovo.";
        showResult(resp);
        markAnswers(resp);
      } catch (ex) {
        if (status) status.textContent = "";
        setErr(ex?.message || "Chyba při odeslání.");
      }
    });
  } catch (e) {
    console.error(e);
    setErr("Chyba: " + (e?.message || "neznámá"));
    document.getElementById("quizCard").innerHTML = "";
  }
})();
</script>



<footer class="footer">
  <div class="container">
    <small>© Think Different Academy</small>
  </div>
</footer>

</body>
</html>
