<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Správa kurzu – Podklady</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>

<header class="topbar">
  <div class="topbar__inner">
    <a class="logo-link" href="/indexlec"><img src="/images/logo.png" alt="Think Different Academy"></a><nav class="nav">
      <a class="nav__link" href="/dashboardLec">Zpět na dashboard</a>
      <a class="nav__link" href="/indexlec">Domů</a>
      <a class="nav__link nav__link--button" href="#" id="logoutBtn">Odhlásit</a>
    </nav>
  </div>
</header>

<main class="container">
  <h1 id="title">Správa podkladů</h1>
  <p class="small" id="meta"></p>

  <p id="err" class="small" style="color:#ff6b6b;"></p>

  <section class="card">
    <h2>Nahrát materiál</h2>

    <form id="uploadForm" class="form">
      <label>
        Název
        <input type="text" name="title" required>
      </label>

      <label>
        Popis
        <input type="text" name="description">
      </label>

      <label>
        Soubor
        <input type="file" name="file" required>
      </label>

      <button type="submit">Nahrát</button>
      <p id="uploadMsg" class="small"></p>
    </form>
  </section>

  <section class="card">
    <h2>Podklady</h2>
    <div id="materials"></div>
  </section>

  <section class="card" style="margin-top:16px;">
    <h2>Kvízy</h2>
    <form id="quizCreateForm" class="form">
      <label>
        Název kvízu
        <input type="text" name="title" required>
      </label>
      <button type="submit">Vytvořit kvíz</button>
      <p id="quizMsg" class="small"></p>
    </form>
    <div id="quizList"></div>
  </section>

  <section class="card" style="margin-top:16px;">
    <h2>Informační kanál</h2>
    <form id="feedForm" class="form">
      <label>
        Příspěvek lektora
        <textarea name="message" rows="3" required></textarea>
      </label>
      <button type="submit">Přidat příspěvek</button>
      <p id="feedMsg" class="small"></p>
    </form>
    <div id="feedList"></div>
  </section>
</main>

<script>
const TOKEN_KEY = "lecturerToken";

function token() {
  return localStorage.getItem(TOKEN_KEY);
}

function requireLogin() {
  if (!token()) location.href = "/loginLec";
}

function courseId() {
  return new URLSearchParams(location.search).get("id");
}

async function loadCourse(id) {
  const res = await fetch(`/api/courses/${encodeURIComponent(id)}`);
  if (!res.ok) throw new Error("Nejde načíst detail kurzu.");
  return await res.json();
}

async function loadMaterials(id) {
  const res = await fetch(`/api/courses/${encodeURIComponent(id)}/materials`);
  if (!res.ok) return [];
  return await res.json();
}

async function updateMaterial(id, materialId, payload) {
  const res = await fetch(`/api/courses/${encodeURIComponent(id)}/materials/${encodeURIComponent(materialId)}`, {
    method: "PUT",
    headers: {
      "Authorization": `Bearer ${token()}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(payload)
  });
  if (!res.ok) {
    const txt = await res.text().catch(() => "");
    throw new Error(`Uprava se nepovedla (HTTP ${res.status}). ` + (txt || ""));
  }
  return await res.json().catch(() => null);
}

async function deleteMaterial(id, materialId) {
  const res = await fetch(`/api/courses/${encodeURIComponent(id)}/materials/${encodeURIComponent(materialId)}`, {
    method: "DELETE",
    headers: { "Authorization": `Bearer ${token()}` }
  });
  if (!res.ok) {
    const txt = await res.text().catch(() => "");
    throw new Error(`Smazani se nepovedlo (HTTP ${res.status}). ` + (txt || ""));
  }
  return await res.json().catch(() => null);
}

function renderMaterials(items) {
  const el = document.getElementById("materials");
  if (!items || items.length === 0) {
    el.innerHTML = "<p class='small'><em>Zatím žádné podklady.</em></p>";
    return;
  }

  el.innerHTML = items.map(m => {
    const type = String(m.type ?? "FILE").toUpperCase();
    if (type === "LINK") {
      return `
        <div class="card" style="margin-top:12px;">
          <strong>${m.title ?? "Odkaz"}</strong><br>
          <span>${m.description ?? ""}</span><br>
          <a href="${m.url ?? ""}" target="_blank" rel="noopener noreferrer">Otevřít odkaz</a>
          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <button type="button" data-action="edit" data-id="${m.id}">Upravit</button>
            <button type="button" data-action="delete" data-id="${m.id}">Smazat</button>
          </div>
        </div>
      `;
    }

    const href = `/api/courses/${encodeURIComponent(courseId())}/materials/${encodeURIComponent(m.id)}/download`;
    return `
      <div class="card" style="margin-top:12px;">
        <strong>${m.title ?? "Materiál"}</strong><br>
        <span>${m.description ?? ""}</span><br>
        <small class="small">${m.originalFilename ?? ""}</small><br>
        <a href="${href}">Stáhnout</a>
        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <button type="button" data-action="edit" data-id="${m.id}">Upravit</button>
          <button type="button" data-action="delete" data-id="${m.id}">Smazat</button>
        </div>
      </div>
    `;
  }).join("");
}

// edit/delete events
document.getElementById("materials").addEventListener("click", async (e) => {
  const btn = e.target.closest("button[data-action]");
  if (!btn) return;
  requireLogin();

  const action = btn.getAttribute("data-action");
  const materialId = btn.getAttribute("data-id");
  const id = courseId();
  if (!id || !materialId) return;

  try {
    const items = await loadMaterials(id);
    const m = (items || []).find(x => String(x.id) === String(materialId));
    if (!m) throw new Error("Materiál už neexistuje.");

    if (action === "delete") {
      if (!confirm(`Opravdu smazat: ${m.title || "materiál"}?`)) return;
      await deleteMaterial(id, materialId);
    }

    if (action === "edit") {
      const type = String(m.type || "FILE").toUpperCase();
      const newTitle = prompt("Nový název:", m.title || "")?.trim();
      if (!newTitle) return;
      let newDesc = prompt("Nový popis (může být prázdný):", m.description || "");
      newDesc = (newDesc == null) ? (m.description || "") : String(newDesc);

      if (type === "LINK") {
        const newUrl = prompt("Nová URL:", m.url || "")?.trim();
        if (!newUrl) return;
        await updateMaterial(id, materialId, { title: newTitle, description: newDesc, url: newUrl });
      } else {
        await updateMaterial(id, materialId, { title: newTitle, description: newDesc });
      }
    }

    const refreshed = await loadMaterials(id);
    renderMaterials(refreshed);
  } catch (err) {
    alert(err?.message || "Chyba.");
  }
});

async function uploadMaterial(id, fd) {
  const res = await fetch(`/api/courses/${encodeURIComponent(id)}/materials`, {
    method: "POST",
    headers: { "Authorization": `Bearer ${token()}` },
    body: fd
  });

  if (!res.ok) {
    const txt = await res.text().catch(() => "");
    throw new Error(`Nahrání se nepovedlo (HTTP ${res.status}). ` + (txt || ""));
  }
  return await res.json();
}

// -------------------- QUIZZES (Fáze 3) --------------------
async function loadQuizzes(id) {
  const res = await fetch(`/api/courses/${encodeURIComponent(id)}/quizzes`);
  if (!res.ok) return [];
  return await res.json();
}

async function createQuiz(id, title) {
  const res = await fetch(`/api/courses/${encodeURIComponent(id)}/quizzes`, {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${token()}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ title })
  });
  if (!res.ok) {
    const txt = await res.text().catch(() => "");
    throw new Error(`Vytvoření kvízu se nepovedlo (HTTP ${res.status}). ` + (txt || ""));
  }
  return await res.json();
}

async function deleteQuiz(id, quizId) {
  const res = await fetch(`/api/courses/${encodeURIComponent(id)}/quizzes/${encodeURIComponent(quizId)}`, {
    method: "DELETE",
    headers: { "Authorization": `Bearer ${token()}` }
  });
  if (!res.ok) {
    const txt = await res.text().catch(() => "");
    throw new Error(`Smazání kvízu se nepovedlo (HTTP ${res.status}). ` + (txt || ""));
  }
  return await res.json().catch(() => null);
}

function renderQuizList(id, list) {
  const el = document.getElementById("quizList");
  if (!list || list.length === 0) {
    el.innerHTML = "<p class='small'><em>Zatím žádné kvízy.</em></p>";
    return;
  }
  el.innerHTML = list.map(q => {
    const filled = Number(q.filledCount || 0);
    const created = q.createdAt ? new Date(q.createdAt).toLocaleString("cs-CZ") : "";
    return `
      <div class="card" style="margin-top:12px;">
        <strong>${q.title || "Kvíz"}</strong>
        <div class="small" style="margin-top:6px; opacity:.85;">Vyplněno: ${filled}${created ? ` • ${created}` : ""}</div>
        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <button type="button" data-q-action="manage" data-q-id="${q.id}">Upravit otázky</button>
          <button type="button" data-q-action="results" data-q-id="${q.id}">Výsledky</button>
          <button type="button" data-q-action="delete" data-q-id="${q.id}">Smazat kvíz</button>
        </div>
      </div>
    `;
  }).join("");
}

document.getElementById("quizCreateForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  requireLogin();
  const msg = document.getElementById("quizMsg");
  msg.textContent = "Vytvářím…";
  const id = courseId();
  const title = (new FormData(e.target).get("title") || "").toString().trim();
  try {
    await createQuiz(id, title);
    msg.textContent = "Hotovo.";
    e.target.reset();
    renderQuizList(id, await loadQuizzes(id));
  } catch (err) {
    msg.textContent = err?.message || "Chyba.";
  }
});

document.getElementById("quizList").addEventListener("click", async (e) => {
  const btn = e.target.closest("button[data-q-action]");
  if (!btn) return;
  requireLogin();

  const action = btn.getAttribute("data-q-action");
  const quizId = btn.getAttribute("data-q-id");
  const id = courseId();

  try {
    if (action === "manage") {
      location.href = `/quizManage?courseId=${encodeURIComponent(id)}&quizId=${encodeURIComponent(quizId)}`;
      return;
    }
    if (action === "results") {
      location.href = `/quizManage?courseId=${encodeURIComponent(id)}&quizId=${encodeURIComponent(quizId)}#results`;
      return;
    }
    if (action === "delete") {
      if (!confirm("Opravdu smazat tento kvíz?")) return;
      await deleteQuiz(id, quizId);
      renderQuizList(id, await loadQuizzes(id));
    }
  } catch (err) {
    alert(err?.message || "Chyba.");
  }
});

// -------------------- FEED (Fáze 4) --------------------
async function loadFeed(id) {
  const res = await fetch(`/api/courses/${encodeURIComponent(id)}/feed`);
  if (!res.ok) return [];
  return await res.json();
}

async function createFeedPost(id, message) {
  const res = await fetch(`/api/courses/${encodeURIComponent(id)}/feed`, {
    method: "POST",
    headers: {
      "Authorization": `Bearer ${token()}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ message })
  });
  if (!res.ok) {
    const txt = await res.text().catch(() => "");
    throw new Error(`Přidání příspěvku se nepovedlo (HTTP ${res.status}). ` + (txt || ""));
  }
  return await res.json();
}

async function updateFeedPost(id, postId, message) {
  const res = await fetch(`/api/courses/${encodeURIComponent(id)}/feed/${encodeURIComponent(postId)}`, {
    method: "PUT",
    headers: {
      "Authorization": `Bearer ${token()}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ message })
  });
  if (!res.ok) {
    const txt = await res.text().catch(() => "");
    throw new Error(`Úprava příspěvku se nepovedla (HTTP ${res.status}). ` + (txt || ""));
  }
  return await res.json();
}

async function deleteFeedPost(id, postId) {
  const res = await fetch(`/api/courses/${encodeURIComponent(id)}/feed/${encodeURIComponent(postId)}`, {
    method: "DELETE",
    headers: { "Authorization": `Bearer ${token()}` }
  });
  if (!res.ok) {
    const txt = await res.text().catch(() => "");
    throw new Error(`Smazání příspěvku se nepovedlo (HTTP ${res.status}). ` + (txt || ""));
  }
  return await res.json().catch(() => null);
}

function renderFeedList(id, list) {
  const el = document.getElementById("feedList");
  if (!list || list.length === 0) {
    el.innerHTML = "<p class='small'><em>Zatím žádné zprávy.</em></p>";
    return;
  }

  el.innerHTML = "";
  list.forEach(it => {
    const card = document.createElement("div");
    card.className = "card";
    card.style.marginTop = "12px";
    card.dataset.feedId = it.id;
    const when = it.createdAt ? new Date(it.createdAt).toLocaleString("cs-CZ") : "";
    const type = String(it.type || "POST").toUpperCase();
    card.innerHTML = `
      <div class="small" style="opacity:.8;">${type === "AUTO" ? "Automatická událost" : "Příspěvek"}${when ? ` • ${when}` : ""}${it.edited ? " • upraveno" : ""}</div>
      <div style="margin-top:8px; white-space:pre-wrap;">${(it.message || "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")}</div>
      ${type === "POST" ? `
        <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
          <button type="button" data-f-action="edit" data-f-id="${it.id}">Upravit</button>
          <button type="button" data-f-action="delete" data-f-id="${it.id}">Smazat</button>
        </div>
      ` : ""}
    `;
    el.appendChild(card);
  });
}

document.getElementById("feedForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  requireLogin();
  const msg = document.getElementById("feedMsg");
  msg.textContent = "Odesílám…";
  const id = courseId();
  const message = (new FormData(e.target).get("message") || "").toString();
  try {
    await createFeedPost(id, message);
    msg.textContent = "Hotovo.";
    e.target.reset();
    renderFeedList(id, await loadFeed(id));
  } catch (err) {
    msg.textContent = err?.message || "Chyba.";
  }
});

document.getElementById("feedList").addEventListener("click", async (e) => {
  const btn = e.target.closest("button[data-f-action]");
  if (!btn) return;
  requireLogin();

  const action = btn.getAttribute("data-f-action");
  const postId = btn.getAttribute("data-f-id");
  const id = courseId();

  try {
    const items = await loadFeed(id);
    const it = (items || []).find(x => String(x.id) === String(postId));
    if (!it) throw new Error("Příspěvek už neexistuje.");

    if (action === "delete") {
      if (!confirm("Opravdu smazat příspěvek?")) return;
      await deleteFeedPost(id, postId);
    }
    if (action === "edit") {
      const newMsg = prompt("Upravit příspěvek:", it.message || "");
      if (newMsg == null) return;
      await updateFeedPost(id, postId, newMsg);
    }
    renderFeedList(id, await loadFeed(id));
  } catch (err) {
    alert(err?.message || "Chyba.");
  }
});

function setupFeedSse(id) {
  try {
    const es = new EventSource(`/api/courses/${encodeURIComponent(id)}/feed/stream`);
    es.addEventListener("feed", async () => {
      // nejjednodušší: reload seznamu
      renderFeedList(id, await loadFeed(id));
    });
  } catch (_) {
    // ignore
  }
}

document.getElementById("logoutBtn").addEventListener("click", (e) => {
  e.preventDefault();
  localStorage.removeItem(TOKEN_KEY);
  location.href = "/index";
});

document.getElementById("uploadForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const msg = document.getElementById("uploadMsg");
  msg.textContent = "Nahrávám...";

  const id = courseId();
  const fd = new FormData(e.target);

  try {
    await uploadMaterial(id, fd);
    msg.textContent = "Hotovo.";
    e.target.reset();

    const items = await loadMaterials(id);
    renderMaterials(items);
  } catch (err) {
    console.error(err);
    msg.textContent = err?.message || "Chyba při nahrávání.";
  }
});

(async () => {
  requireLogin();

  const id = courseId();
  if (!id) {
    document.getElementById("err").textContent = "Chybí parametr ?id=";
    return;
  }

  try {
    const c = await loadCourse(id);
    document.getElementById("title").textContent = `Správa podkladů: ${c.title ?? ""}`;
    document.getElementById("meta").textContent = c.lecturer ? `Lektor: ${c.lecturer}` : "";

    const items = await loadMaterials(id);
    renderMaterials(items);
  } catch (err) {
    console.error(err);
    document.getElementById("err").textContent = "Chyba při načítání dat.";
  }
})();
</script>



<footer class="footer">
  <div class="container">
    <small>© Think Different Academy</small>
  </div>
</footer>

</body>
</html>
